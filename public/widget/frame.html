<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UltaAI Widget</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .typing-dots {
            display: inline-flex;
            gap: 3px;
        }
        .typing-dots span {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #666;
            animation: typing 1.5s infinite;
        }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; transform: scale(0.8); }
            30% { opacity: 1; transform: scale(1); }
        }
        
        .message {
            margin-bottom: 16px;
            animation: messageSlideIn 0.3s ease-out;
        }
        
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="widget-container">
        <div class="widget-header">
            <div class="widget-logo hidden" id="widget-logo">
                <span>AI</span>
            </div>
            <div class="widget-title" id="widget-title">UltaAI Assistant</div>
        </div>
        
        <div class="widget-content" id="widget-content">
            <!-- Loading state (initial) -->
            <div class="loading-container" id="loading-state">
                <div class="loading-spinner"></div>
                <div class="welcome-message">Initializing widget...</div>
                <div class="status-message" id="status-message">Connecting to UltaAI services</div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            'use strict';
            
            let widgetConfig = null;
            let clientOpts = {};
            
            // Parse URL parameters
            function getUrlParams() {
                const params = new URLSearchParams(window.location.search);
                return {
                    siteKey: params.get('site_key'),
                    origin: params.get('origin'),
                    opts: params.get('opts'),
                    userId: params.get('user_id'),
                    timestamp: params.get('timestamp'),
                    signature: params.get('signature')
                };
            }
            
            // Parse client options from URL
            function parseClientOptions(optsString) {
                try {
                    return optsString ? JSON.parse(decodeURIComponent(optsString)) : {};
                } catch (error) {
                    console.error('Failed to parse client options:', error);
                    return {};
                }
            }
            
            // Analytics helper
            function emitAnalyticsEvent(eventType, siteKey, metadata) {
                try {
                    const origin = window.parent ? window.parent.location.origin : window.location.origin;
                    const pageUrl = window.parent ? window.parent.location.href : window.location.href;
                    
                    fetch(`${window.location.origin}/supabase/functions/v1/widget-analytics`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            event_type: eventType,
                            site_key: siteKey,
                            origin: origin,
                            page_url: pageUrl,
                            metadata: metadata || {}
                        })
                    }).catch(error => {
                        console.debug('Analytics event failed:', error);
                    });
                } catch (error) {
                    console.debug('Analytics error:', error);
                }
            }
            
            // Merge server theme with client options (client wins)
            function mergeThemeWithOptions(serverConfig, clientOptions) {
                const serverTheme = serverConfig.theme || {};
                
                return {
                    colorPrimary: clientOptions.colorPrimary || serverTheme.color_primary || '#007bff',
                    textColor: clientOptions.textColor || serverTheme.text_color || '#333333',
                    logoUrl: clientOptions.logoUrl || serverTheme.logo_url || '',
                    welcomeText: clientOptions.welcomeText || serverTheme.welcome_text || 'Hello! How can I help you today?'
                };
            }
            
            // Apply theme to the widget
            function applyTheme(theme) {
                const root = document.documentElement;
                
                // Apply CSS custom properties
                root.style.setProperty('--color-primary', theme.colorPrimary);
                root.style.setProperty('--text-color', theme.textColor);
                
                // Apply chat message colors (use primary color for user messages)
                root.style.setProperty('--user-message-bg', theme.colorPrimary);
                root.style.setProperty('--user-message-text', '#ffffff');
                root.style.setProperty('--assistant-message-bg', '#f1f3f4');
                root.style.setProperty('--assistant-message-text', theme.textColor);
                
                // Apply input and send button colors
                root.style.setProperty('--send-button-bg', theme.colorPrimary);
                root.style.setProperty('--send-button-text', '#ffffff');
                
                // Apply logo
                const logoEl = document.getElementById('widget-logo');
                if (theme.logoUrl && theme.logoUrl.trim()) {
                    logoEl.innerHTML = `<img src="${theme.logoUrl}" alt="Logo" onerror="this.parentElement.classList.add('hidden')">`;
                    logoEl.classList.remove('hidden');
                } else {
                    logoEl.innerHTML = '<span>AI</span>';
                    logoEl.classList.add('hidden');
                }
            }
            
            // Fetch widget configuration from server
            async function fetchWidgetConfig(siteKey, origin, userId, timestamp, signature) {
                const baseUrl = window.location.protocol + '//' + window.location.host;
                let url = `${baseUrl}/supabase/functions/v1/widget-admin-api/api/widget/config?site_key=${encodeURIComponent(siteKey)}&origin=${encodeURIComponent(origin)}`;
                
                // Add user identity parameters if provided
                if (userId && timestamp && signature) {
                    url += `&user_id=${encodeURIComponent(userId)}`;
                    url += `&timestamp=${encodeURIComponent(timestamp)}`;
                    url += `&signature=${encodeURIComponent(signature)}`;
                }
                
                try {
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        
                        // Emit config fetch denied event
                        emitAnalyticsEvent('config_fetch_denied', siteKey, {
                            error: errorData.error || `HTTP ${response.status}`,
                            status_code: response.status,
                            has_user_identity: !!(userId && signature)
                        });
                        
                        throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    // Emit config fetch success event
                    emitAnalyticsEvent('config_fetch_ok', siteKey, {
                        widget_name: data.name,
                        has_user_identity: !!(userId && data.user)
                    });
                    
                    return data;
                } catch (error) {
                    console.error('Failed to fetch widget config:', error);
                    
                    // Emit config fetch denied event for network/other errors
                    emitAnalyticsEvent('config_fetch_denied', siteKey, {
                        error: error.message,
                        error_type: 'network_error'
                    });
                    
                    throw error;
                }
            }
            
            // Render error state
            function renderError(error, canRetry = true) {
                const contentEl = document.getElementById('widget-content');
                const isPermissionError = error.message.includes('not allowed') || error.message.includes('403');
                
                contentEl.innerHTML = `
                    <div class="error-container">
                        <div class="error-title">
                            <span>⚠️</span>
                            <span>${isPermissionError ? 'Access Denied' : 'Configuration Error'}</span>
                        </div>
                        <div class="error-message">
                            ${isPermissionError 
                                ? 'This widget is not authorized to load on this domain.' 
                                : 'Unable to load widget configuration.'}
                        </div>
                        ${canRetry ? `<button class="retry-button" onclick="initWidget()">Retry</button>` : ''}
                        <div class="error-details">${error.message}</div>
                    </div>
                `;
            }
            
            // Render success state with content
            function renderWidget(config, theme, user) {
                const contentEl = document.getElementById('widget-content');
                
                // Create a container for the React app
                contentEl.innerHTML = `
                    <div id="react-chat-root" style="height: 100%; display: flex; flex-direction: column;">
                        <div class="loading-container">
                            <div class="loading-spinner"></div>
                            <div class="welcome-message">Loading chat interface...</div>
                        </div>
                    </div>
                `;
                
                // Emit preview render event
                const { siteKey } = getUrlParams();
                emitAnalyticsEvent('preview_render', siteKey, {
                    widget_name: config.name,
                    welcome_text_length: (theme.welcomeText || '').length
                });
                
                // Update title
                document.getElementById('widget-title').textContent = config.name || 'UltaAI Assistant';
                
                // Load the full React-based chat system
                loadFullChatSystem(config, theme, user);
                
                // Show user debug panel if authenticated
                if (user) {
                    showUserDebug(user);
                }
            }
            
            // Load the full chat system (same as ChatDemo)
            function loadFullChatSystem(config, theme, user) {
                // Import the ChatWidget React component dynamically
                import('./ChatWidget.js').then(({ ChatWidget }) => {
                    const root = document.getElementById('react-chat-root');
                    
                    // Initialize the full chat widget
                    const widget = React.createElement(ChatWidget, {
                        supabaseUrl: `${window.location.protocol}//${window.location.hostname.includes('supabase.co') ? window.location.hostname : 'lfsdqyvvboapsyeauchm.supabase.co'}`,
                        supabaseAnonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxmc2RxeXZ2Ym9hcHN5ZWF1Y2htIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMjA3ODYsImV4cCI6MjA3MTg5Njc4Nn0.8lE_UEjrIviFz6nygL7HocGho-aUG9YH1NCi6y_CrFk',
                        tenantId: config.customer_id,
                        userId: user?.id,
                        theme: 'auto',
                        position: 'embedded',
                        iframeSafe: true,
                        widgetTheme: {
                            ...theme,
                            widget_initial_state: 'open'
                        },
                        embedded: true
                    });
                    
                    ReactDOM.render(widget, root);
                }).catch(error => {
                    console.error('Failed to load ChatWidget:', error);
                    // Fallback to the enhanced static interface
                    renderEnhancedStaticInterface(config, theme, user);
                });
            }
            
            // Enhanced static interface with more realistic chat simulation
            function renderEnhancedStaticInterface(config, theme, user) {
                const contentEl = document.getElementById('widget-content');
                
                contentEl.innerHTML = `
                    <div class="chat-container" style="height: 100%; display: flex; flex-direction: column;">
                        <div class="chat-messages" style="flex: 1; overflow-y: auto; padding: 16px;">
                            <div class="message assistant-message">
                                <div class="message-bubble">
                                    <div class="message-text">${theme.welcomeText}</div>
                                    <div class="quick-actions">
                                        <button class="quick-action" onclick="simulateTask('install_wordpress')">Install WordPress</button>
                                        <button class="quick-action" onclick="simulateTask('check_system')">Check System</button>
                                        <button class="quick-action" onclick="simulateTask('restart_services')">Restart Services</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chat-input-container" style="padding: 16px; border-top: 1px solid #e1e5e9;">
                            <div class="chat-input" style="display: flex; gap: 8px;">
                                <input type="text" id="message-input" placeholder="Ask me to manage your server..." 
                                       style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;"
                                       onkeypress="handleKeyPress(event)">
                                <button class="send-button" onclick="sendMessage()" 
                                        style="padding: 12px 20px; background: ${theme.colorPrimary}; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                    Send
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <style>
                        .quick-actions {
                            margin-top: 12px;
                            display: flex;
                            gap: 8px;
                            flex-wrap: wrap;
                        }
                        .quick-action {
                            padding: 6px 12px;
                            background: ${theme.colorPrimary}15;
                            color: ${theme.colorPrimary};
                            border: 1px solid ${theme.colorPrimary}30;
                            border-radius: 16px;
                            font-size: 12px;
                            cursor: pointer;
                            transition: all 0.2s;
                        }
                        .quick-action:hover {
                            background: ${theme.colorPrimary}25;
                        }
                        .task-status {
                            margin-top: 12px;
                            padding: 12px;
                            background: #f8f9fa;
                            border-radius: 8px;
                            border-left: 4px solid ${theme.colorPrimary};
                        }
                        .task-progress {
                            height: 4px;
                            background: #e1e5e9;
                            border-radius: 2px;
                            margin-top: 8px;
                            overflow: hidden;
                        }
                        .task-progress-bar {
                            height: 100%;
                            background: ${theme.colorPrimary};
                            transition: width 0.3s ease;
                        }
                    </style>
                `;
            }
            
            // Show user debug panel if user is authenticated
            function showUserDebug(user) {
                const debugPanel = document.createElement('div');
                debugPanel.className = 'user-debug-panel';
                debugPanel.innerHTML = `
                    <div class="debug-title">🔐 Authenticated User</div>
                    <div class="debug-content">
                        <div><strong>User ID:</strong> ${user.id}</div>
                        <div><strong>Status:</strong> Verified</div>
                    </div>
                `;
                document.body.appendChild(debugPanel);
            }
            
            // Update loading status
            function updateStatus(message) {
                const statusEl = document.getElementById('status-message');
                if (statusEl) {
                    statusEl.textContent = message;
                }
            }
            
            // Initialize widget
            async function initWidget() {
                const params = getUrlParams();
                
                // Validate required parameters
                if (!params.siteKey) {
                    renderError(new Error('Missing site_key parameter'), false);
                    return;
                }
                
                // Parse client options
                clientOpts = parseClientOptions(params.opts);
                
                try {
                    // Check if this is preview mode
                    if (params.siteKey === 'preview-key') {
                        // Preview mode - use client options directly
                        updateStatus('Loading preview...');
                        
                        widgetConfig = {
                            id: 'preview',
                            name: 'Widget Preview',
                            site_key: 'preview-key',
                            theme: {
                                color_primary: clientOpts.colorPrimary || '#007bff',
                                text_color: clientOpts.textColor || '#333333',
                                logo_url: clientOpts.logoUrl || '',
                                welcome_text: clientOpts.welcomeText || 'Hello! How can I help you today?'
                            }
                        };
                        
                        const mergedTheme = mergeThemeWithOptions(widgetConfig, clientOpts);
                        applyTheme(mergedTheme);
                        
                        // Small delay to show the loading state
                        await new Promise(resolve => setTimeout(resolve, 300));
                        
                        // Render the widget interface
                        renderWidget(widgetConfig, mergedTheme, null);
                        
                    } else {
                        // Production mode - fetch from server
                        if (!params.origin) {
                            renderError(new Error('Missing origin parameter'), false);
                            return;
                        }
                        
                        // Update loading status
                        updateStatus('Verifying permissions...');
                        
                        // Fetch configuration from server
                        widgetConfig = await fetchWidgetConfig(params.siteKey, params.origin, params.userId, params.timestamp, params.signature);
                        
                        // Merge theme with client options
                        const mergedTheme = mergeThemeWithOptions(widgetConfig, clientOpts);
                        
                        // Apply theme
                        updateStatus('Applying theme...');
                        applyTheme(mergedTheme);
                        
                        // Small delay to show the loading state
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        // Render the widget interface
                        renderWidget(widgetConfig, mergedTheme, widgetConfig.user);
                    }
                    
                } catch (error) {
                    console.error('Widget initialization failed:', error);
                    renderError(error);
                }
            }
            
            // Interactive chat functions
            window.simulateTask = function(taskType) {
                const messagesContainer = document.querySelector('.chat-messages');
                const taskMessages = {
                    'install_wordpress': {
                        user: 'Install WordPress on my Ubuntu server',
                        assistant: 'I\'ll help you install WordPress. Let me check your system and begin the installation.',
                        status: 'Installing WordPress...',
                        steps: ['Downloading WordPress', 'Creating database', 'Configuring files', 'Setting permissions']
                    },
                    'check_system': {
                        user: 'Check my system status',
                        assistant: 'Running system diagnostics to check your server health.',
                        status: 'Checking system status...',
                        steps: ['CPU usage', 'Memory usage', 'Disk space', 'Network status']
                    },
                    'restart_services': {
                        user: 'Restart web services',
                        assistant: 'I\'ll restart your web services safely. This will ensure optimal performance.',
                        status: 'Restarting services...',
                        steps: ['Stopping services', 'Checking configurations', 'Starting services', 'Verifying status']
                    }
                };
                
                const task = taskMessages[taskType];
                if (!task) return;
                
                // Add user message
                const userMsg = document.createElement('div');
                userMsg.className = 'message user-message';
                userMsg.innerHTML = `
                    <div class="message-bubble">
                        <div class="message-text">${task.user}</div>
                    </div>
                `;
                messagesContainer.appendChild(userMsg);
                
                // Add assistant response with task status
                setTimeout(() => {
                    const assistantMsg = document.createElement('div');
                    assistantMsg.className = 'message assistant-message';
                    assistantMsg.innerHTML = `
                        <div class="message-bubble">
                            <div class="message-text">${task.assistant}</div>
                            <div class="task-status">
                                <div style="font-weight: 500; margin-bottom: 8px;">${task.status}</div>
                                <div class="task-progress">
                                    <div class="task-progress-bar" style="width: 0%"></div>
                                </div>
                                <div style="font-size: 12px; color: #666; margin-top: 4px;">Initializing...</div>
                            </div>
                        </div>
                    `;
                    messagesContainer.appendChild(assistantMsg);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    
                    // Simulate progress
                    const progressBar = assistantMsg.querySelector('.task-progress-bar');
                    const statusText = assistantMsg.querySelector('.task-status div:last-child');
                    let progress = 0;
                    let stepIndex = 0;
                    
                    const progressInterval = setInterval(() => {
                        progress += Math.random() * 25;
                        if (progress > 100) progress = 100;
                        
                        progressBar.style.width = progress + '%';
                        
                        if (stepIndex < task.steps.length) {
                            statusText.textContent = task.steps[stepIndex];
                            if (progress > (stepIndex + 1) * 25) stepIndex++;
                        }
                        
                        if (progress >= 100) {
                            clearInterval(progressInterval);
                            statusText.textContent = 'Completed successfully!';
                            statusText.style.color = '#22c55e';
                            
                            // Add completion message
                            setTimeout(() => {
                                const completionMsg = document.createElement('div');
                                completionMsg.className = 'message assistant-message';
                                completionMsg.innerHTML = `
                                    <div class="message-bubble">
                                        <div class="message-text">✅ Task completed successfully! The ${taskType.replace('_', ' ')} operation has finished.</div>
                                    </div>
                                `;
                                messagesContainer.appendChild(completionMsg);
                                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                            }, 1000);
                        }
                    }, 500);
                    
                }, 1000);
                
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            };
            
            window.sendMessage = function() {
                const input = document.getElementById('message-input');
                const message = input.value.trim();
                if (!message) return;
                
                const messagesContainer = document.querySelector('.chat-messages');
                
                // Add user message
                const userMsg = document.createElement('div');
                userMsg.className = 'message user-message';
                userMsg.innerHTML = `
                    <div class="message-bubble">
                        <div class="message-text">${message}</div>
                    </div>
                `;
                messagesContainer.appendChild(userMsg);
                
                // Clear input
                input.value = '';
                
                // Add typing indicator
                setTimeout(() => {
                    const typingMsg = document.createElement('div');
                    typingMsg.className = 'message assistant-message typing-indicator';
                    typingMsg.innerHTML = `
                        <div class="message-bubble">
                            <div class="message-text">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div class="typing-dots">
                                        <span></span><span></span><span></span>
                                    </div>
                                    <span style="font-size: 12px; color: #666;">AI is thinking...</span>
                                </div>
                            </div>
                        </div>
                    `;
                    messagesContainer.appendChild(typingMsg);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    
                    // Remove typing indicator and add response
                    setTimeout(() => {
                        messagesContainer.removeChild(typingMsg);
                        
                        const responses = [
                            "I understand you want to " + message.toLowerCase() + ". Let me help you with that task.",
                            "I'll analyze your request and provide the appropriate solution for your server.",
                            "This looks like a system administration task. I can help you execute this safely.",
                            "I'm processing your request. This will involve checking your system configuration first."
                        ];
                        
                        const assistantMsg = document.createElement('div');
                        assistantMsg.className = 'message assistant-message';
                        assistantMsg.innerHTML = `
                            <div class="message-bubble">
                                <div class="message-text">${responses[Math.floor(Math.random() * responses.length)]}</div>
                                <div class="quick-actions">
                                    <button class="quick-action" onclick="simulateTask('check_system')">Check Prerequisites</button>
                                    <button class="quick-action" onclick="simulateTask('install_wordpress')">Execute Task</button>
                                </div>
                            </div>
                        `;
                        messagesContainer.appendChild(assistantMsg);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }, 2000);
                    
                }, 500);
                
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            };
            
            window.handleKeyPress = function(event) {
                if (event.key === 'Enter') {
                    sendMessage();
                }
            };
            
            // Make initWidget globally available for retry functionality
            window.initWidget = initWidget;
            
            // Start initialization when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initWidget);
            } else {
                initWidget();
            }
        })();
    </script>
</body>
</html>