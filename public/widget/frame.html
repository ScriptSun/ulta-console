<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AltaAI Widget</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="widget-container">
        <div class="widget-header">
            <div class="widget-logo hidden" id="widget-logo">
                <span>AI</span>
            </div>
            <div class="widget-title" id="widget-title">AltaAI Assistant</div>
        </div>
        
        <div class="widget-content" id="widget-content">
            <!-- Loading state (initial) -->
            <div class="loading-container" id="loading-state">
                <div class="loading-spinner"></div>
                <div class="welcome-message">Initializing widget...</div>
                <div class="status-message" id="status-message">Connecting to AltaAI services</div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            'use strict';
            
            let widgetConfig = null;
            let clientOpts = {};
            
            // Parse URL parameters
            function getUrlParams() {
                const params = new URLSearchParams(window.location.search);
                return {
                    siteKey: params.get('site_key'),
                    origin: params.get('origin'),
                    opts: params.get('opts'),
                    userId: params.get('user_id'),
                    timestamp: params.get('timestamp'),
                    signature: params.get('signature')
                };
            }
            
            // Parse client options from URL
            function parseClientOptions(optsString) {
                try {
                    return optsString ? JSON.parse(decodeURIComponent(optsString)) : {};
                } catch (error) {
                    console.error('Failed to parse client options:', error);
                    return {};
                }
            }
            
            // Analytics helper
            function emitAnalyticsEvent(eventType, siteKey, metadata) {
                try {
                    const origin = window.parent ? window.parent.location.origin : window.location.origin;
                    const pageUrl = window.parent ? window.parent.location.href : window.location.href;
                    
                    fetch(`${window.location.origin}/supabase/functions/v1/widget-analytics`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            event_type: eventType,
                            site_key: siteKey,
                            origin: origin,
                            page_url: pageUrl,
                            metadata: metadata || {}
                        })
                    }).catch(error => {
                        console.debug('Analytics event failed:', error);
                    });
                } catch (error) {
                    console.debug('Analytics error:', error);
                }
            }
            
            // Merge server theme with client options (client wins)
            function mergeThemeWithOptions(serverConfig, clientOptions) {
                const serverTheme = serverConfig.theme || {};
                
                return {
                    colorPrimary: clientOptions.colorPrimary || serverTheme.color_primary || '#007bff',
                    textColor: clientOptions.textColor || serverTheme.text_color || '#333333',
                    logoUrl: clientOptions.logoUrl || serverTheme.logo_url || '',
                    welcomeText: clientOptions.welcomeText || serverTheme.welcome_text || 'Hello! How can I help you today?'
                };
            }
            
            // Apply theme to the widget
            function applyTheme(theme) {
                const root = document.documentElement;
                
                // Apply CSS custom properties
                root.style.setProperty('--color-primary', theme.colorPrimary);
                root.style.setProperty('--text-color', theme.textColor);
                
                // Apply logo
                const logoEl = document.getElementById('widget-logo');
                if (theme.logoUrl && theme.logoUrl.trim()) {
                    logoEl.innerHTML = `<img src="${theme.logoUrl}" alt="Logo" onerror="this.parentElement.classList.add('hidden')">`;
                    logoEl.classList.remove('hidden');
                } else {
                    logoEl.innerHTML = '<span>AI</span>';
                    logoEl.classList.add('hidden');
                }
            }
            
            // Fetch widget configuration from server
            async function fetchWidgetConfig(siteKey, origin, userId, timestamp, signature) {
                const baseUrl = window.location.protocol + '//' + window.location.host;
                let url = `${baseUrl}/supabase/functions/v1/widget-admin-api/api/widget/config?site_key=${encodeURIComponent(siteKey)}&origin=${encodeURIComponent(origin)}`;
                
                // Add user identity parameters if provided
                if (userId && timestamp && signature) {
                    url += `&user_id=${encodeURIComponent(userId)}`;
                    url += `&timestamp=${encodeURIComponent(timestamp)}`;
                    url += `&signature=${encodeURIComponent(signature)}`;
                }
                
                try {
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        
                        // Emit config fetch denied event
                        emitAnalyticsEvent('config_fetch_denied', siteKey, {
                            error: errorData.error || `HTTP ${response.status}`,
                            status_code: response.status,
                            has_user_identity: !!(userId && signature)
                        });
                        
                        throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    // Emit config fetch success event
                    emitAnalyticsEvent('config_fetch_ok', siteKey, {
                        widget_name: data.name,
                        has_user_identity: !!(userId && data.user)
                    });
                    
                    return data;
                } catch (error) {
                    console.error('Failed to fetch widget config:', error);
                    
                    // Emit config fetch denied event for network/other errors
                    emitAnalyticsEvent('config_fetch_denied', siteKey, {
                        error: error.message,
                        error_type: 'network_error'
                    });
                    
                    throw error;
                }
            }
            
            // Render error state
            function renderError(error, canRetry = true) {
                const contentEl = document.getElementById('widget-content');
                const isPermissionError = error.message.includes('not allowed') || error.message.includes('403');
                
                contentEl.innerHTML = `
                    <div class="error-container">
                        <div class="error-title">
                            <span>‚ö†Ô∏è</span>
                            <span>${isPermissionError ? 'Access Denied' : 'Configuration Error'}</span>
                        </div>
                        <div class="error-message">
                            ${isPermissionError 
                                ? 'This widget is not authorized to load on this domain.' 
                                : 'Unable to load widget configuration.'}
                        </div>
                        ${canRetry ? `<button class="retry-button" onclick="initWidget()">Retry</button>` : ''}
                        <div class="error-details">${error.message}</div>
                    </div>
                `;
            }
            
            // Render success state with content
            function renderWidget(config, theme, user) {
                const contentEl = document.getElementById('widget-content');
                
                contentEl.innerHTML = `
                    <div class="welcome-section">
                        <div class="welcome-message">${theme.welcomeText}</div>
                        <div class="welcome-subtitle">I'm here to help you with any questions.</div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="action-button" onclick="startChat()">
                            <span>üí¨</span>
                            <span>Start Chat</span>
                        </button>
                        <button class="action-button secondary" onclick="showSupport()">
                            <span>üìß</span>
                            <span>Contact Support</span>
                        </button>
                    </div>
                `;
                
                // Emit preview render event
                const { siteKey } = getUrlParams();
                emitAnalyticsEvent('preview_render', siteKey, {
                    widget_name: config.name,
                    welcome_text_length: (theme.welcomeText || '').length
                });
                
                // Update title
                document.getElementById('widget-title').textContent = config.name || 'AltaAI Assistant';
                
                // Show user debug panel if authenticated
                if (user) {
                    showUserDebug(user);
                }
            }
            
            // Show user debug panel if user is authenticated
            function showUserDebug(user) {
                const debugPanel = document.createElement('div');
                debugPanel.className = 'user-debug-panel';
                debugPanel.innerHTML = `
                    <div class="debug-title">üîê Authenticated User</div>
                    <div class="debug-content">
                        <div><strong>User ID:</strong> ${user.id}</div>
                        <div><strong>Status:</strong> Verified</div>
                    </div>
                `;
                document.body.appendChild(debugPanel);
            }
            
            // Update loading status
            function updateStatus(message) {
                const statusEl = document.getElementById('status-message');
                if (statusEl) {
                    statusEl.textContent = message;
                }
            }
            
            // Initialize widget
            async function initWidget() {
                const params = getUrlParams();
                
                // Validate required parameters
                if (!params.siteKey) {
                    renderError(new Error('Missing site_key parameter'), false);
                    return;
                }
                
                if (!params.origin) {
                    renderError(new Error('Missing origin parameter'), false);
                    return;
                }
                
                // Parse client options
                clientOpts = parseClientOptions(params.opts);
                
                try {
                    // Update loading status
                    updateStatus('Verifying permissions...');
                    
                    // Fetch configuration from server
                    widgetConfig = await fetchWidgetConfig(params.siteKey, params.origin, params.userId, params.timestamp, params.signature);
                    
                    // Merge theme with client options
                    const mergedTheme = mergeThemeWithOptions(widgetConfig, clientOpts);
                    
                    // Apply theme
                    updateStatus('Applying theme...');
                    applyTheme(mergedTheme);
                    
                    // Small delay to show the loading state
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Render the widget interface
                    renderWidget(widgetConfig, mergedTheme, widgetConfig.user);
                    
                } catch (error) {
                    console.error('Widget initialization failed:', error);
                    renderError(error);
                }
            }
            
            // Button action handlers (placeholder functions)
            window.startChat = function() {
                console.log('Start chat clicked');
                // This will be implemented later for actual chat functionality
                alert('Chat functionality coming soon!');
            };
            
            window.showSupport = function() {
                console.log('Contact support clicked');
                // This will be implemented later for support functionality
                alert('Support functionality coming soon!');
            };
            
            // Make initWidget globally available for retry functionality
            window.initWidget = initWidget;
            
            // Start initialization when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initWidget);
            } else {
                initWidget();
            }
        })();
    </script>
</body>
</html>